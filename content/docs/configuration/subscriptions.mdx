---
title: Subscriptions
description: How to manage subscriptions with Stripe.
---

<Callout type="warning" twClass="mt-0">
  To complete this guide, you'll need to create an account on
  [Stripe](https://stripe.com/).
</Callout>

## Configuration

<Steps>

### Create a Project

After logging in, create a project on Stripe.

### Obtain Stripe API Key

In "Developer" mode, go to "API Keys" and copy the secret key.

Paste it into your `.env` file.

```js
STRIPE_API_KEY = sk_your_secret_key
```

### Set up Stripe Webhook

Create a webhook to manage Stripe events within your app.

1. **Create Webhook Endpoint:** Go to your Stripe dashboard and navigate to "Developers" > "Webhooks". Click on "Add endpoint" to create a new webhook.
2. **Configure Webhook:** Enter the endpoint URL where Stripe will send events. This URL should point to a route in your application that can handle Stripe webhook events.

3. **Select Events:** Choose the events you want to receive notifications for.
   Common events include `checkout.session.completed`, `customer.subscription.updated`, `invoice.payment_succeeded`, etc.

4. **Obtain Webhook Signing Secret:** After setting up the webhook, Stripe will generate a signing secret. Copy this secret and paste it into your `.env` file as `STRIPE_WEBHOOK_SECRET`.

```js
STRIPE_WEBHOOK_SECRET = whsec_your_secret_webhook
```

### Create Price Cards

Create price cards to obtain price IDs for both monthly and yearly plans.

1. **Navigate to Products:** In your Stripe dashboard, go to "Products" > "Create Product". Enter the details for your subscription product, such as name, description, and pricing.

2. **Create Pricing Plans:** Once the product is created, go to the "Pricing" section and click on "Add pricing plan". Set up the details for your pricing plan, including the amount, currency, billing interval (monthly or yearly), and any other relevant information.

3. **Obtain Price IDs:** After creating the pricing plans, Stripe will generate unique price IDs for each plan. These IDs are used to identify the specific pricing plan when creating subscriptions. Copy the price IDs for both the monthly and yearly plans and paste them into your `.env` file as follows:

```js
NEXT_PUBLIC_STRIPE_PRO_MONTHLY_PLAN_ID = price_FaKeId
NEXT_PUBLIC_STRIPE_PRO_YEARLY_PLAN_ID = price_FaKeId

NEXT_PUBLIC_STRIPE_BUSINESS_MONTHLY_PLAN_ID = price_FaKeId
NEXT_PUBLIC_STRIPE_BUSINESS_YEARLY_PLAN_ID = price_FaKeId
```

Ensure that you replace `price_FaKeId` with the actual price IDs generated by Stripe for your pricing plans.

<Callout type="warning">
  Don't forget to change the prices in `config/subscriptions.ts`.
</Callout>

## Going Live with Stripe

When you're ready to accept real payments, you'll need to switch from test mode to live mode.

### 1. Update API Keys

1. In your Stripe dashboard, go to **Developers** > **API Keys**
2. Copy your **live secret key** (starts with `sk_live_`)

**Security Recommendation**: Create a **Restricted API key** instead of using the standard key:

1. Click **"Create restricted key"**
2. Set appropriate permissions:
   - **Write access**: Products, Prices, Checkout Sessions, Customers, Subscriptions, Invoices, Payment Methods, Webhook Endpoints
   - **Read access**: All other resources (Events, Balance, etc.)
   - **No access**: Test mode, Radar, Sigma, etc.

**Why Restricted Keys?**
- **Enhanced Security**: Limits what your application can do if compromised
- **Principle of Least Privilege**: Only access what's needed for your SaaS
- **Audit Trail**: Stripe tracks what each key accesses
- **Easier Recovery**: If compromised, restricted keys limit potential damage

**Standard vs Restricted Keys:**
- **Standard Key**: Full access to your Stripe account (not recommended for production)
- **Restricted Key**: Only access to specific resources you define (recommended)

```js
# Use restricted key for better security
STRIPE_API_KEY="sk_live_your_restricted_key"
```

### 2. Update Webhook Endpoint

1. In Stripe dashboard, go to **Developers** > **Webhooks**
2. Add a new webhook endpoint pointing to your **production domain** (e.g., `https://yourdomain.com/api/webhooks/stripe`)
3. Copy the new webhook secret and update your `.env` file
4. Select the same events as your test webhook

### 3. Create Live Products

**Option A: Create New Products (Recommended)**
1. In Stripe dashboard, go to **Products**
2. Create new products identical to your test products
3. Copy the new price IDs and update your `.env` file

**Option B: Convert Test Products**
1. Go to **Developers** > **API Keys**
2. Temporarily switch back to test keys
3. Use the Stripe CLI to copy products: `stripe products list --live` then recreate in live mode

### 4. Update Environment Variables

Update your production environment variables with the live price IDs:

```js
NEXT_PUBLIC_STRIPE_PRO_MONTHLY_PLAN_ID="price_live_monthly_id"
NEXT_PUBLIC_STRIPE_PRO_YEARLY_PLAN_ID="price_live_yearly_id"
NEXT_PUBLIC_STRIPE_BUSINESS_MONTHLY_PLAN_ID="price_live_monthly_id"
NEXT_PUBLIC_STRIPE_BUSINESS_YEARLY_PLAN_ID="price_live_yearly_id"
```

### 5. Deploy and Test Webhooks

1. **Deploy your application** to Netlify or your hosting platform
2. **Set environment variables** in your production environment
3. **Configure webhook endpoint** in Stripe dashboard pointing to your production URL
4. **Test the complete flow**:
   - Make a test purchase
   - Check that user subscription is created in your database
   - Verify webhook events appear in Stripe dashboard

### Environment Variables for Production

Your production `.env` file should include:

```bash
# Production Database
DATABASE_URL="your_production_database_url"

# Production Stripe (Restricted API Key)
STRIPE_API_KEY="sk_live_your_restricted_key"
STRIPE_WEBHOOK_SECRET="whsec_your_live_webhook_secret"

# Production Clerk
NEXT_PUBLIC_CLERK_PUBLISHABLE_KEY="pk_live_..."
CLERK_SECRET_KEY="sk_live_..."

# Other production variables...
```

### Webhook Event Handling

Your webhook endpoint (`/api/webhooks/stripe`) handles these events:

- **`checkout.session.completed`**: Creates subscription in database when user purchases
- **`invoice.payment_succeeded`**: Updates subscription on successful renewal payment
- **`customer.subscription.updated`**: Handles subscription plan changes
- **`customer.subscription.deleted`**: Handles subscription cancellations

<Callout type="info">
  **Webhook URL Format**: `https://yourdomain.com/api/webhooks/stripe`

  Replace `yourdomain.com` with your actual production domain.
</Callout>

</Steps>
